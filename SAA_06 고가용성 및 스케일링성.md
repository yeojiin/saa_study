### 확장성(scalability)
- 수직 확장성(vertical scalability)
    - 인스턴스의 크키를 키움 -> 5개를 처리할 수 있던 것을 10개로 처리 할 수 있도록
    - t2micro 를 t2large로 바꾸는 것
    - **DB와 같이 분산되지 않은** 시스템에 주로 사용
    - RDS, ElasticCache, DB
    - 하드웨어 제한이 있어 확장에 한계가 있음
- 수평 확장성(수평)(horizontal scalability = elasticity)
    - 어플리케이션이나 인스턴스의 수를 늘리는 것 -> 같은 처리 량 인스턴스의 수를 늘림
    - 분배 시스템에 유리
### 고가용성(High availability)
- 어플리케이션 또는 시스템을 적어도 `둘 이상의 AWS의 **AZ나 데이터 선테에서** 가동 중`
- 데이터 센터에서의 손실에서 살아남는 것 -> 센터 하나가 멈춰도 유지 가능
- 수동적 고가용성:  RDS다중 AZ를 갖출 경우
- 활성형 고가용성: 수평 확장 -> 같은 AZ에 인스턴스를 늘림
### 정리
- 수직적 확장(스케일링): 인스턴스 크키를 늘림 (스케일 업/ 스케일 다운)
    - micro -> large
- 수평적 확장: 인스턴스 수를 늘림(스케일 아웃(수 늘림)/스케일 인(수 줄임))
    - 오토 스케일링 그룹 사용 가능
    - 로드 밸런서
- 고가용성: 같은 어플리케이션 및 인스턴스를 다수의 AZ에 실행
    - 다중 AZ가 활성화된 오토 스케일링 및 로드 밸런서에서 사용 가능
- 스케일 아웃: 인스턴스 수를 늘림
- 스케일 인: 인스턴스 수를 줄임
### ELB(Elastic Load Balancing)
- 서버 혹은 서버셋으로 트래픽을 백엔드나 다운스트림 EC2 인스턴스 또는 서버들로 전달하는 역할
- 부하를 다수의 다운스트림 인스턴스로 분산하기 위해 사용
- 어플리케이션에는 단일 엑세스 지점(DNS)를 노출(ELB) 가 받고, 다운스트림 인스턴스의 장애를 확인해 트래픽을 어디로 보낼 지 원활히 처리
- 로그 밸런서가 어떤 인스턴스로 트래픽을 보낼 수 없는지 확인, 연결된 EC2가 아닌 다른 인스턴스를 찾기 때문에
- SSL도 종료할 수 있어 웹사이트에 암호화된 HTTPS 트래픽도 가질 수 있음
- 쿠키로 고정도를 강화할 수 있고, 영역에 걸친 고가용성을 가짐
- 클라우드 내에서 개인 트래픽과 공공 트래픽을 분리할 수도 있음
- `관리형 로드 밸런서` 라서 사용
    - AWS가 관리하며 어떤 경우도 작동할 것을 보장 -> 자체 로그밸서보다 저렴하고 기능이 많음
    - 다수의 AWS 서비스들과 통합되어 있음
        - EC2 인스턴스와도 통합이 가능하고
        - 스케일링 그룹 Amazon ECS와 인증서 관리(ACM),  CloudWatch, Route 53, WAF Global Accelerator 등도 연결 가능
- HTTP 프로토콜을 사용하고, 4567포트, /heath 엔트 포인트를 사용(커스텀할 수 있음
- **Health Check**
- 상태 확인은 포트와 라우트에서 이루어짐
- HTTP 상태 코드로 응답 -> 200이면 정상
- 로드 밸런스 종류
    - 클래식 로드 밸런스: 기존 세대, V1이라고 하며, 2009년에 만들어진 CLB라고 함
        - HTTP, HTTPS, TCP, SSL, secure TCP 지원
        - 미권장
    - 신형 로드밸런스: 2016, ALB, V2
        - HTTP, HTTPS, WebSocket
    - 네트워크 로그밸런스: 2017, NLB, V2
        - TCP, TLS(secure TCP), UDP
    - 게이트웨이 로드밸런스: 2020, GWLB
        - 네트워크 계층에서 작동해 3계층, IP 프로토콜
- 내부에 설치되어 private 서버에 접속 가능, external에 설치되면 외부 어플리케이션 등에 접속 가능한 로드밸런스도 존재
- 유저는 HTTP나 HTTPS로 접근 가능, 포트는 80(HTTP), 443(HTTPS)이고 소스는 0.0.0.0/0으로 어디서든 접근 가능하게 설정 가능
- 로드밸런스-EC2 보안 그룹은 포트 80, HTTP 허용하고, IP범위가 아닌 소스는 보안 그룹으로 설정 -> 로드밸런스 보안그룹과 EC2 보안그룹을 연결해 허용된 트래픽만 허용
### ALB(V2)
- Applicaion Load Balance는 7계층, HTTP 전용 로드 밸런서
- 머신간 다수 HTTP 어플리케이션 라우팅에 사용
- 컨테이너와 ECS를 사용
- HTTP/2 와 WebSocket 지원
- redirect도 지원 (HTTP -> HHTPS로)
- 경로 라우팅도 지원
    - ex) example.com/users 또는 example.com/posts 같이 경로로 구분
- url 호스트 라우팅 지원
    -  ex) one.example.com 또는 other.example.com
- 쿼리 스트링, 헤더 라우팅 지원
    - ex) example.com/users?id=123&order=false
- 포트 매칭 기능이 있음
- 클래식 로드 밸런스(CLB)는 다수의 어플리케이션을 쓴다면 여러개의 클래식 로드 밸런스가 필요한데 ALB는 하나만 있어도 됨
- 대상 그룹:
    - EC2 인스턴스
    - ECS
    - 람다 함수
    - IP주소 - 사설 IP주소여야 함, 개인 서버
- 상태 확인은 대상 그룹 레벨에서 이루어짐
- 고정 호스트 이름이 부여됨
    - `X-Forworded-Port` 헤더에 클라이언트 IP가 삽입되고 X-Forworded-Port를 사용하는 포트와 X-Forworded-Proto에 의해 사용되는 프로토콜을 얻게 됨
### 로드 밸런서 종료
- Application Load Balancer: HTTP, HTTPS 트래픽
- Network Load Blanacer: TCP, UDP 프로토콜, TCP 기반의 TLS
    - 초고성능, 지연시간 최소화
- Gateway Load Balancer: 보안, 침입 탐지, 방화벽
### Network Load Balancer V2(NLB)
-  Layer 4(L4) 로드 밸런서이므로 `TCP와 UDP` 프로토콜 트래픽을 받을 수 있음 -> L7보다 하위 계층
- 성능이 매우 높음, 짧은 지연 시간
- `가용 영역별(AZ)로 하나의 고정 IP를 갖음`, 탄력적 IP 주소를 각 AZ에 할당 가능
    - 여러 개의 고정 IP를 가진 어플리케이션을 노출할 때 용이
- 1~3개의 IP로만 어플리케이션을 구현해야할 경우, 고성능, TCP, UDP,  정적 IP 문제 -> NLB 고려
- AWS 프리 티어 기능이 아님
- NLB 작동방식
    - 대상그룹으로 리다이렉트 함
    - 백엔드, 프론트엔드 모두 TCP를 사용하거나 백엔드는 HTTP, 프론트엔드는 TCP를 사용할 수 있음
    - TCP 프로토콜로 들어와서 NLB를 거쳐 TCP로 대상 그룹에 전달할 수 도 있고, HTTP로 변환해서 전달하는 것도 가능
    - 대상그룹 대상
        - EC2 인스턴스
        - IP 주소 -> 반드시 하드코딩 되어야 하고 프라이빗 IP여야 함
        -  ALB 도 사용 가능: NLB를 ALB 앞에 배치
            - NLB로 고정 IP 주소를 얻고, ALB로 HTTP 유형의 트래픽을 처리하는 규칙을 얻을 수 있음
    - 상태 확인: TCP, HTTP, HTTPS 프로토콜에 대한 상태 확인 가능
### Gateway Load Balancer
- GWLB는 배포 및 확장과 AWS의 타사 네트워크 가상 어플라이언스의 플릿 관리에 사용됨
- 네트워크의 모든 트래픽이 통과하지 못하게 하거나 침입 탐지 및 방지 시스템에 사용됨
    - IDPS나 심층패킷 분석 시스템, 일부 페이로드가 수정이 가능하나 **네트워크 수준** 에서만 가능함
    - 사용자 트래픽 -> GWLB -> 타켓 그룹(가상의 어플리게이션 그룹) -> 타겟 그룹에서 `해당 트래픽이 유효한지 확인, 방화벽 등을 체크` -> 실패하면 트래픽을 드롭하고, 성공이면 다시 GWLB로 보냄 -> GWLB에서 실제 인스턴스로 트래픽 전송
-  네트워크 L3 계층
- 투명 네트워크 게이트웨이 -> 단일 엔트리인 GWLB와 출구를 통과
- 로드 밸런서 -> 대상 그룹의 가상 어플라이언스 집합에 트래픽을 분산해 LB가 되기 때문
- 6081 포트 사용
- 대상 그룹:
    - 타사 어플라이언스: EC2 인스턴스이거나 인스턴스 ID로 등록
    - IP 주소: private IP -> 개인 IP여야 하고, 자체 네트워크나 자체 데이터 선터에서 가상 어플라이언스를 실행하면 IP로 수동 등록 가능
### Sticky Sessions(고정 세션)
- 로드 밸런서에 2가지 요청을 수행하는 클라이언트가 요청에 응답하기 위해 `백엔드에 동일한 인스턴스`를 갖는 것
- A 클라리언트가 요청 1을 하고 요청 2를 할 때 로드 밸런서가 둘다 같은 EC2인 1번 EC2 인스턴스로 보내고, B클라이언트 요청과 C 클라이언트 요청은 2번 EC2로 보냄
- CLB와 ALB에서도 설정 가능
- 쿠키가 사용되어 고정성과 만료 기간을 갖음 -> **쿠키가 만료되면 클라이언트가 다른 EC2 인스턴스로 리디렉션 됨**
- 사용자 로그인 같은 경우 세션을 잃지 않기 위해 동일한 EC2로 보내는 경우
- 하지만 고정성을 활성화 할 경우 EC2 인스턴스 부하에 불균형을 초래할 수 있음
- 어플리케이션 기반 쿠키
    - 사용자 정의 쿠키
        -  어플리케이션에서 생성됨 -> 만료 기간을 어플리케이션에서 관리
        - 쿠키 이름은 대상 그룹별로 각각 생성해야 함
        - AWSALB, AWSALBAPP, AWSALBTG 등은 사용하면 안됨 -> ELB에서 사용하고 있기 때문
    - 어플리케이션 쿠키
        - 로드밸런서 자체에서 생성
        - ALB의 쿠키 이름은 AWSALBAPP 으로 사용
- 기간 기반 쿠키
    - 로드밸런서에서 생성
    - ALB에서 AWSALB로 사용되고, CLB에서 AWSELB로 사용됨
    - 특정 기간을 기반으로 만료되는데 이는 로드밸런서에서 관리함

### 크로스존 로드밸런싱
![[Pasted image 20231101154455.png]]
- 크로스존 로드밸런싱을 사용하면 로드밸런서와 상관없이 떠있는 모든 인서턴스의 갯수(10개)를 동등하게 트래픽을 나눠 갖음
- 크로스존 로드밸런싱을 사용하지 않으면 로드밸런서가 먼저 나눠진 트래픽을 받고 그 안에서 인스턴스 갯수만큼 각자 트래픽을 나눠 갖음
- 어플리케이션 로드밸런서는 기본적으로 크로스존 로드밸런싱이 활성화 되어 있음 -> AZ 간의 데이터 이동에 비용이 들지 않음
- 네트워크 로드밸런서와 게이트웨이 로드밸런서는 기본적으로 크로스존 로드밸런싱이 비활성화 되어 있음 -> 비용을 지불하고 써야함, 데이터 이동에 비용이 듦
- CLB는 크로스존 로드밸런싱이 비활성화 되어 있지만 활성화 해도 데이터간 이동에 비용이 발생하지 않음
### SSL/TSL
- SSL 인증서는 클라이언트와 로드 밸런서 사이에서 트래픽이 이동하는 동안 암호화 해줌 = in-flight 함호화
- 데이터는 네트워크를 이동하는 중에는 암호화 되고, 송진자와 수신자 측에서만 복호화가 가능해야함
- SSL: 보안 계층 소켓으로 연결을 암호화, TSL 전송 계층 보안(새로운 버전 SSL이라고 많이 불림)
- 퍼블릭 SSL은 CA라는 인증 기관에서 발급 -> 인증서를 로드밸런서에 추가하면 클라이언트와 로브밸런서 사이에 연결을 암호화
- SSL 인증서는 만료 날짜가 존재 해 갱신 필요
- HTTPS 로 접속 -> 로드 밸런서 -> SSL종료(SSL Termination) -> HTTP로 EC2와 통신(암호화 되지 않지만 private network를 사용해 네트워크가  보안됨)
- 로드밸런서는 X.509 인증서를 사용하는데, SSL 또는 TLS 서버 인증서라고 함
- ACM(Aws 인증서 관리) -> AWS에 존재
    - ACM에 인증서를 업로드 할 수 있는데 HTTP리스너를 구성할 때 HTTPS 리스너로 해야함
    - 클라이언트는 SNI(server name indication, 서버 이름 지정)을 써서 접속할 호스트의 이름을 알릴 수 있음
- 원하는대로 보안 정책을 지정할 수 있음
### SNI
- 여러 개의 SSL 인증서를 하나의 웹 서버에 로드해 하나의 웹 서버가 여러 개의 웹사이트를 지원할 수 있게 함 -> multiple SSL certificates onto one web server
- 확장된 프로토콜로, 클라이언트가 대상 서버의 호스트 이름을 지정하도록 함
- 여러 개의 SSL은 애플리케이션 로드 밸런서, 네트워크 로드 밸런서, CloudFront에서만 동작, CLB는 동작하지 않음
- 로드 밸런서에 SSL인증서가 여러 개 있다면 ALB나 NLB 둘 중 하나
- ALB가 SSL을 여러 개 가지고 있고 호스트 endpoint로 접속할 때 ALB는 구분 해서 대상 그룹의 SSL을 가져 올 수 있음 -> SNI 를 사용해서 어떤 대상인지 찾음
### 연결 드레이닝(Connection Draining)
- 클랙식 로드 밸런서를 사용할 경우 연결 드레이닝, ALB || NLB는 등록 취소 지연(Deregistration Delay) 라고 부름
- 인스턴스가 등록 취소 또는 비정상 상태일 때 지연을 두고 활성화 되도록 기다림
- 사용자의 요청으로 EC2 1번이 연결되면 드래이닝 상태도 다른 사용자가 요청하면  첫번째 사용자의 요청이 끝날 때까지 다른 EC2 찾음
### 오토 스케일링(ASG)
- 스케일 아웃: 증가한 로드에 맞춰 EC2인스턴스를 추가하거나
- 스케일 인: 감소한 로드에 맞춰 EC2인스턴드 줄임
- 위 두개를 최대/최소 매개변수를 지정해 자동으로 조정
- 인스턴스가 비정상이면 종료하고 이를 대체할 새 EC2를 생서하기도 함
- 최소 용량, 희망 용량 설정 후 최대 용량 만큼 추가하거나 줄일 수 있음
- 사용자 - ELB - ASG - EC2 연결됨
- 인스턴스 기반으로 ASG를 사용하면 `시작 템플릿을 설정해야함(Launch Template)`
    - 매배 변수로 EC2유저 데이터 등등 다양한 정보를 직접 입력
### CloudWatch 알람 & 스케일링
- cloudwatch 경보를 기반으로 ASG를 스케일 인,아웃 할 수 있음
- 알람이 울리면 EC2 갯수가 늘어나 스케일 아웃 됨
- 지표에 따라서 경보가 울림 -> 경보에 따라 내부에서 자동으로 스케일 아웃/인이 발생
- 분당 요청과 같은 지표가 CloudWatch에 존재하지 않아 경보를 생성하려면 사용자 지정 지표를 먼저 만들어야 함
### ASG 정책
- 동적 스케일링 정책
    - 대상 추척 스케일링(target tracking scaling)
        - 모든 EC2 인스턴스에서 오토스케일링 그룹의 평균 CPU 사용률을 추적해 수치가 40%대에 머물도록 정책을 세움
    - Simple/Step 스케일링
        - 전체 ASG에 대한 CPU 사용률이 70%를 초과하는 경우 용량을 늘리도록 설정, 30%로 떨어지면 줄이도록 설정하거나 할 수 있음
        - 한번에 추가할 유닛 수와 제거할 유닛 수를 지정해야함 -> 단계별 지정
    - 스케쥴 액션
        - 최소 용량을 매주 금요일 5시에 10으로 늘리도록 작업한다는 식으로 스케줄을 지정해서 관리
            - 대규모 프로모션 등이 있을 때 사용하면 용이
    - 예측 스케일링(predictive scaling)
        - 시간에 따라 로드를 분석해서 예측이 생성되고 사전에 스켕일이 작업이 진행됨
        - 머신러닝을 이용할 수도 있음
- 좋은 ASG 지표
    - CPU 사용률 기준
    - 테스트를 기반으로 요청 수 측정 ->  평균적으로 EC2 인스턴스에 3개의 미해결 요청이 발생할 경우 RequestCountPerTarget을 3으로 지정로 지정하는 방식으로 사용
    - 네트워크에 연결된 경우 평균 네트워크 입출력량을 기준으로 **특정 임계값에 도달하면** 스케일링
    - 개별 설정 -> CloudWatch에서 어플리케이션 별로 지표를 설정하고 이를 기반으로 스케일링
- 스케일링 쿨 다운
    - 인스턴스의 추가 또는 삭제와 관계없이 5분 혹은 300초의 휴지 기간을 갖는 것
    - 휴지 기간에는 ASG를 인스턴스를 새로 추가하거나 죽일 수 없음
    - 기본 설정된 휴지가 있는지 확인해야함
    - 즉시 사용가능한 AMI를 사용해 인스턴스를 신속히 처리하는 것도 가능 -> 휴지 시간이 줄어들음
    - 세부 모니터링 설정도 가능
